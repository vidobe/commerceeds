import{events as fe}from"@dropins/tools/event-bus.js";import{B as z,i as re,V as $,u as he,D as ge,m as Fe,l as pe,E as ve}from"./getStoreConfig.js";import{b as K,a as g,A as N,e as Ie,D as q,g as Ee,M as Q,c as ee}from"./getMultilineValues.js";import{r as L}from"./transform-shipping-methods.js";import{useState as U,useEffect as x,useCallback as P,useRef as ke,useMemo as Ae}from"@dropins/tools/preact-hooks.js";import{classes as B,getFormErrors as Ce,VComponent as w}from"@dropins/tools/lib.js";import{Text as ne,useText as be}from"@dropins/tools/i18n.js";import{Field as Z,Input as oe,Picker as Se,Skeleton as we,SkeletonRow as C,ProgressSpinner as Me}from"@dropins/tools/components.js";/* empty css                     */import{jsx as a,Fragment as V,jsxs as O}from"@dropins/tools/preact-jsx-runtime.js";import{forwardRef as Re,useRef as $e,useImperativeHandle as Le,useState as j,useEffect as X}from"@dropins/tools/preact-compat.js";const Y={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function ae(e){return Object.keys(e).length===0&&e.constructor===Object}const ye=e=>e.map(t=>{var n;const r=((n=t==null?void 0:t.id)==null?void 0:n.toString())||t.code;return{text:t.name,value:r}}),De=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function Ne({address:e,addressType:t,availableCountries:r,availableRegions:n,config:s,dismissError:c,errors:o,fields:d,onBlur:m,onChange:i,onInvalid:F,onSelection:I,setAddress:p}){const E=()=>{p(u=>({...u,[g.Region]:"",[g.RegionId]:""})),c(g.Region)},R=u=>{p(f=>({...f,[g.RegionId]:u}))};return d.map(u=>{var v;let f,k=u.frontendInput,A,y=u.isDisabled,D=u.isRequired,M=[],l;if(k===z.Multiline?(l=K(u.code,e),f=K(u.code,o)):(l=e[u.code],f=o[u.code]||""),u.code===g.Country&&(M=De(r),t===N.SHIPPING?(L.value.country=l,A=h=>{const b=h.target,{value:S}=b;S&&W({country_code:S}),I(h),E()}):A=I),u.code===g.RegionId&&t===N.SHIPPING&&(L.value.selectedRegionId=l),u.code===g.Region){if(t===L.value.addressType&&(y=L.value.pending),D=s.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),M=ye(n),!D&&!s.displayStateIfOptional&&(k=z.Undefined),k=M.length>0?z.Select:z.Text,k===z.Select)t===N.SHIPPING?(L.value.selectedRegion=l,A=h=>{const S=h.target.value;W({country_code:L.value.country,region_id:S}),I(h),R(S)}):A=h=>{I(h);const S=h.target.value;R(S)};else if(k===z.Text&&t===N.SHIPPING){L.value.selectedRegion=l;const h=i;i=b=>{const S=b.target,{value:H}=S;L.value.country&&W({country_code:L.value.country,region_name:H}),h(b)}}l=M.length>0?((v=M.find(h=>h.value===l))==null?void 0:v.value)||"":l}return u.code===g.PostCode&&(D=!s.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...u,error:f,frontendInput:k,handleSelect:A,isDisabled:y,isRequired:D,onBlur:m,onChange:i,onInvalid:F,options:M,value:l}})}let te;function W(e){var c;const t=re.value.data,r=!!t,n=(c=t==null?void 0:t.shippingAddresses)==null?void 0:c[0],s=n==null?void 0:n.availableShippingMethods;r&&!s&&(clearTimeout(te),te=setTimeout(()=>{Ie({cartId:t.id,criteria:e})},q))}const G=({addressType:e,code:t,index:r})=>r?`${e}-${t}-${r}`:`${e}-${t}`,T=e=>`checkout-address-form__${e}`,_e=({addressType:e,element:t})=>{const{code:r,value:n,defaultValue:s}=t;return a("input",{className:T(r),id:G({addressType:e,code:r}),name:r,type:"hidden",value:n||s},r)},xe=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:s,label:c,onBlur:o,onChange:d,onInvalid:m,validateRules:i,value:F}=t,I=se(i);return a(Z,{disabled:s,error:n,children:a(oe,{"aria-label":c,autocomplete:Y[r]||"off",className:T(r),floatingLabel:`${c} ${t.isRequired?"*":""}`,id:G({addressType:e,code:r}),onBlur:o,onChange:d,onInvalid:m,placeholder:c,required:t.isRequired||!1,type:"text",name:r,value:F??void 0,...I})})},ze=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:s,isRequired:c,label:o,multilineCount:d,onBlur:m,onChange:i,onInvalid:F,validateRules:I,value:p}=t,E=d??0,R=se(I);return a(V,{children:Array.from(Array(E).keys()).map(u=>a(Z,{disabled:s,error:(n==null?void 0:n[u])||"",className:"dropin-field--multiline",children:a(oe,{id:G({addressType:e,code:r,index:u}),className:T(r),floatingLabel:`${o} ${u!=0?u:""} ${c&&u===0?"*":""}`,autocomplete:u===0?Y[r]:"off","aria-label":o,placeholder:`${o} ${u!=0?u:""}`,type:"text",required:c&&u===0,onChange:i,onBlur:m,onInvalid:F,name:`${r}-${u}`,value:(p==null?void 0:p[u])||void 0,...R})},`${r}-${u}`))})},Pe=({addressType:e,element:t})=>{const{code:r,error:n,handleSelect:s,isDisabled:c,isRequired:o,label:d,onBlur:m,onInvalid:i,options:F,value:I}=t,p=s?{handleSelect:s}:{};return a(Z,{disabled:c,error:n,children:a(Se,{id:G({addressType:e,code:r}),className:T(r),name:r,floatingLabel:`${d} ${o?"*":""}`,required:o,placeholder:d,"aria-label":d,options:F,value:I,autocomplete:Y[r]||"off",onBlur:m,onInvalid:i,...p},r)})},Oe=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return _e({addressType:e,element:t});case"TEXT":return xe({addressType:e,element:t});case"MULTILINE":return ze({addressType:e,element:t});case"SELECT":return Pe({addressType:e,element:t});default:return null}},se=e=>e?e.reduce((t,r)=>{switch(r.name){case $.DateRangeMax:return{...t,max:r.value};case $.DateRangeMin:return{...t,min:r.value};case $.FileExtensions:return{...t,accept:r.value};case $.InputValidation:return{...t,pattern:Ve(r.value)};case $.MaxFileSize:case $.MaxImageHeight:case $.MaxImageWidth:return t;case $.MaxTextLength:return{...t,maxLength:r.value};case $.MinTextLength:return{...t,minLength:r.value};default:throw new Error(`Unknown rule: ${r.name}`)}},{}):{},_={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},Ve=e=>{switch(e){case"alpha":return _.alpha.source;case"alphanumeric":return _.alphanumeric.source;case"alphanumeric-w-space":return _["alphanumeric-w-space"].source;case"alphanum-with-spaces":return _["alphanum-with-spaces"].source;case"url":return _.url.source;case"numeric":return _.numeric.source;case"email":return _.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},Be=e=>O(we,{...e,children:[a(C,{variant:"heading",size:"medium"}),a(C,{variant:"empty",size:"medium"}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large",fullWidth:!0}),a(C,{size:"large",fullWidth:!0,lines:3}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large"}),a(C,{size:"large"})]}),Ue=({addressType:e,className:t,fields:r,formRef:n,headingId:s,name:c,...o})=>O("div",{...o,className:B(["checkout-fields-form",t]),children:[a(ue,{level:2,children:a(ne,{id:s}),className:"checkout-fields-form__title"}),a("form",{name:c,ref:n,className:B(["checkout-fields-form__form",t]),noValidate:!0,children:r.sort((d,m)=>!d.sortOrder||!m.sortOrder?d.code<m.code?-1:1:d.sortOrder-m.sortOrder).map(d=>Oe({element:d,addressType:e}))})]}),Ge=e=>{const t=new FormData(e),r=Object.fromEntries(t);return Object.entries(r).reduce((s,[c])=>{const o=e.elements[c];return o!=null&&o.validationMessage?{...s,[c]:o.validationMessage}:{...s}},{})};function Te(e){const[t,r]=j({});return X(()=>{e&&r(n=>({...n,country_id:e}))},[e]),{defaultValues:t}}function He({country:e,addressType:t}){const[r,n]=j([]);return X(()=>{if(!e){n([]);return}Ee(e,t).then(s=>{n(s||[])}).catch(s=>{console.error(s)})},[n,e,t]),{availableRegions:r}}function We({autoFill:e,addressType:t,loadAutoFill:r}){const[n,s]=j(!1),c=pe.value.data,o=!!c,d=re.value.data,m=!!d;X(()=>{var u;if(!e||!m||n)return;let i,F=!1;i=tt({addressType:t,cart:d}),!i&&o&&(i=et({addressType:t,customer:c}),F=!0);const I=f=>f?f.split(ee).length>1:!1;if(!i)return;s(!0);const p={[g.City]:i.city,[g.Company]:i.company||"",[g.Country]:i.country.value,[g.FirstName]:i.firstName,[g.LastName]:i.lastName,[g.PostCode]:i.postCode||"",[g.Telephone]:i.telephone||"",[g.Vat]:i.vatId||""},E=i.region;if(E){const f=(u=E==null?void 0:E.id)==null?void 0:u.toString();f?(p[g.Region]=f,p[g.RegionId]=f):p[g.Region]=E.code}i!=null&&i.street&&i.street.length>0&&i.street.forEach((f,k)=>{p[`${g.Street}${Q}${k}`]=f}),((i==null?void 0:i.customAttributes)||[]).forEach(f=>{I(f.code)?f.value.split(ee).forEach((A,y)=>{p[`${f.code}${Q}${y}`]=A}):p[f.code]=f.value}),r({values:p,triggerAutoSave:F})},[t,e,d,c,n,m,o,r])}const Et=Re(({addressType:e,autoFill:t=!0,children:r,headingId:n,name:s,preselectedFields:c,saveAddressHandler:o,...d},m)=>{const{fields:i}=he(),{countries:F}=ge(),I=F===void 0,p=i===void 0,{config:E}=Fe(),R=E===void 0,{defaultValues:u}=Te(E==null?void 0:E.defaultCountry),f=Qe({fields:i,preselectedFields:c}),k=$e(null),{address:A,errors:y,loadAutoFill:D,onBlur:M,dismissError:l,onChange:v,onInvalid:h,onSelection:b,setAddress:S}=Je({formRef:k,type:e,defaultValues:u,preselection:f,saveAddressHandler:o}),{availableRegions:H}=He({country:A.country_id,addressType:e});if(Le(m,()=>({triggerSaveAddress:de=>{if(!k.current)return;const me=Ge(k.current);if(ae(me))return o({signal:de,address:A})}})),We({addressType:e,autoFill:t,loadAutoFill:D}),p||I||R)return a(Be,{"data-testid":`${e}-skeleton`});const le=Ne({address:A,addressType:e,availableCountries:F,availableRegions:H,config:E,dismissError:l,errors:y,fields:i,onBlur:M,onChange:v,onInvalid:h,onSelection:b,setAddress:S}),J={[N.SHIPPING]:"shipping",[N.BILLING]:"billing"};return a(Ue,{...d,name:s,addressType:e,className:`checkout-${J[e]}-form`,"data-testid":`${J[e]}-form`,fields:le,formRef:k,headingId:n})});function qe(e){const{backupService:t}=ve(),[r,n]=U(null);x(()=>{const o=t.restore(e);o&&n(o)},[e,t]),x(()=>{const o=fe.on("checkout/order",()=>{t.remove(e)});return()=>{o==null||o.off()}},[e,t]);const s=P(o=>setTimeout(()=>{t.backup(e,o)},q),[e,t]),c=P(()=>{t.remove(e)},[e,t]);return{addressBackup:r,backup:s,removeBackup:c}}const Ze={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},je=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],Xe=e=>{const[t,r]=U({}),n=P(c=>{const{name:o,validity:d,validationMessage:m}=c;let i=d.valid?"":m;je.forEach(F=>{if(!d[F])return;const I=e[F];if(!I)return;const p=Ze[F];i=I.replace("{field}",c.getAttribute(p)||"")}),r(F=>({...F,[o]:i}))},[e]);return{errors:t,dismissError:c=>{t[c]&&r(o=>{const{[c]:d,...m}=o;return m})},validateFormElement:n}},Ye=e=>{const t=e.current;if(!t)return!1;const r=Ce(t);return ae(r)},Je=({formRef:e,type:t,defaultValues:r={},preselection:n={},saveAddressHandler:s})=>{const c=be({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),o=ke(!1),[d,m]=U({}),{addressBackup:i,backup:F,removeBackup:I}=qe(t),{errors:p,validateFormElement:E,dismissError:R}=Xe(c),u=P(l=>{o.current=!1,s(l).then(()=>{I()}).catch(v=>{o.current=!0,console.error("Saving address form failed:",v)})},[I,s]),f=(l,v)=>{m(h=>({...h,[l]:v})),o.current=!0},k=({values:l,triggerAutoSave:v=!1})=>{m(h=>({...h,...l})),v&&(o.current=!0)},A=l=>{const v=l.target,{name:h,value:b}=v;f(h,b),E(v)},y=l=>{const v=l.target;E(v)},D=l=>{const v=l.target,{name:h,value:b}=v;f(h,b),E(v)},M=l=>{l.target.checkValidity()};return x(()=>{m(l=>({...r,...n,...i,...l}))},[r,n,i]),x(()=>{if(!o.current)return;const l=F(d);return()=>{clearTimeout(l)}},[d,F]),x(()=>{if(!o.current||!Ye(e))return;const l=new AbortController,v=l.signal,h=setTimeout(()=>{u({signal:v,address:d})},q);return()=>{clearTimeout(h),l.abort()}},[d,e,u]),{address:d,errors:p,loadAutoFill:k,dismissError:R,onChange:A,onSelection:D,onBlur:M,onInvalid:y,setAddress:m}},Ke={countryCode:g.Country,region:g.Region,postCode:g.PostCode};function Qe({fields:e,preselectedFields:t}){return Ae(()=>!(!!e&&e.length>0)||!!!t?{}:Object.keys(t).reduce((s,c)=>{const o=Ke[c];return!o||!e.some(m=>m.code===o)?s:{...s,[o]:t[c]}},{}),[e,t])}const et=({addressType:e,customer:t})=>e===N.BILLING?t.defaultBillingAddress:t.defaultShippingAddress,tt=({addressType:e,cart:t})=>{if(e===N.BILLING)return t.billingAddress;const r=t.shippingAddresses;if(!(!r||r.length===0))return r[0]},rt=()=>{const e=()=>window.innerWidth>=1920?"xxlarge":window.innerWidth>=1366?"xlarge":window.innerWidth>=1024?"large":window.innerWidth>=768?"medium":"small",[t,r]=U(e());return x(()=>{let n;const s=()=>{n&&clearTimeout(n),n=setTimeout(()=>r(e()),50)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),n&&clearTimeout(n)}},[]),t},ie=({children:e,className:t})=>rt()==="small"?a(V,{children:e}):a("div",{className:t,children:e}),nt=({sections:e})=>a(ie,{className:"checkout__aside",children:O(V,{children:[a(w,{node:e.orderSummary}),a(w,{node:e.cartSummary})]})}),ot=({billingAddress:e,billToShippingAddress:t,login:r,paymentMethods:n,placeOrder:s,shippingAddress:c,shippingMethods:o})=>O(V,{children:[a(w,{node:r}),c&&a(w,{node:c}),t&&a(w,{node:t}),o&&a(w,{node:o}),a(w,{node:n}),a(w,{node:e}),a(w,{node:s})]}),at=({outOfStock:e,sections:t})=>a(ie,{className:"checkout__main",children:O(V,{children:[a(ue,{level:1,className:"checkout-title",children:a(ne,{id:"Checkout.title"})}),e&&a(w,{className:"checkout-outOfStock",node:e}),t&&a(ot,{...t})]})}),ce=({banner:e,children:t,className:r,isLoading:n=!1,...s})=>O("div",{"data-testid":"checkout",className:B(["checkout",r]),...s,children:[n&&a(it,{}),e&&a(w,{className:"checkout__banner",node:e}),a("div",{className:"checkout__content",children:t})]});ce.Main=at;ce.Aside=nt;const ue=({className:e,children:t,level:r=2})=>{const n=r>=1&&r<=6?`h${r}`:"h2";return a(n,{className:e,children:t})},st=()=>{const e=P(()=>{document.body.style.overflow="hidden"},[]),t=P(()=>{document.body.style.overflow=""},[]);return{lockScroll:e,unlockScroll:t}},it=({className:e})=>{const{lockScroll:t,unlockScroll:r}=st();return x(()=>(t(),r),[t,r]),a("div",{"data-testid":"checkout-overlay-loader",className:B(["checkout-overlay-loader",e]),children:a(Me,{})})};export{Et as A,ce as C,ue as H,_ as p,rt as u};
//# sourceMappingURL=ToggleButton.js.map
